# Maintainer: Spacingbat3 (https://github.com/spacingbat3)
pkgname=webcord-git
pkgver=v1.1.0_pre1.r67.cbfb1a7
pkgrel=1
pkgdesc="A Discord client based on the Electron engine."
arch=("any")

_repo="electron-discord-webapp"
_author="SpacingBat3"

license=('MIT')
makedepends=('npm' 'git' 'jq')
depends=('electron')
provides=("${pkgname%-git}")
conflicts=("${pkgname%-git}")
source=("${pkgname%-git}::git+https://github.com/${_author}/${_repo}.git"
        "${pkgname%-git}.desktop")
md5sums=('SKIP'
         '85d234a65c69f3cf817fac5c54c194c8')


pkgver() {
    cd "${srcdir}/${pkgname%-git}"
    printf "v%s.r%s.%s" "$(cat ./package.json | jq -r '.version' | tr '-' '_')" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "${srcdir}/${pkgname%-git}"
    npm install --only=prod
}

build() {
    _terminal() {
        printf "#!/bin/bash\nelectron /usr/lib/${pkgname%-git}.asar\nexit \$?">"$1"
    }
    cd "${srcdir}/${pkgname%-git}"
    [[ -f docs/COPYING ]] && mv docs/COPYING ../ && rm -R docs
    [[ -f build ]] && rm -R build
    [[ -f ../${pkgname%-git}.asar ]] && rm ../${pkgname%-git}.asar
    npx asar pack . ../${pkgname%-git}.asar
    _desktop "${srcdir}/${pkgname%-git}.desktop"
    _terminal "${srcdir}/${pkgname%-git}.sh"
}

package() {
    cd "${srcdir}"
    install -Dm755 "${srcdir}/${pkgname%-git}.asar" "${pkgdir}/usr/lib/${pkgname%-git}.asar"
    install -Dm644 "${srcdir}/COPYING" "${pkgdir}/usr/share/licenses/${pkgname%-git}/COPYING"
    install -Dm644 "${srcdir}/${pkgname%-git}/icons/app.png" "${pkgdir}/usr/share/icons/hicolor/512x512/apps/webcord.png"
    install -Dm644 "${srcdir}/${pkgname%-git}/icons/extra/iconThemes/Papirus/webcord.png" "${pkgdir}/usr/share/icons/Papirus/128x128/apps/webcord.png" 
    install -Dm755 "${srcdir}/${pkgname%-git}.desktop" "${pkgdir}/usr/share/applications/${pkgname%-git}.desktop"   
    install -Dm755 "${srcdir}/${pkgname%-git}.sh" "${pkgdir}/usr/bin/${pkgname%-git}"
}
